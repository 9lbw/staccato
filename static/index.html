<!DOCTYPE html>
<html>
<head>
    <title>test</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import "https://www.nerdfonts.com/assets/css/webfont.css";
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace; 
            background: #0a0a0a; 
            color: #e0e0e0; 
            line-height: 1.4;
            font-size: 13px;
            overflow-x: hidden;
        }
        
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 2000;
            background: #ffffff;
            color: #000000;
            border: none;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #000000;
            border-right: 2px solid #333;
            padding: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .logo {
            font-size: 16px;
            font-weight: normal;
            color: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #333;
            background: #111;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .nav-item {
            display: block;
            color: #888;
            text-decoration: none;
            padding: 16px 20px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: none;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
        }
        
        .nav-item:hover {
            color: #ffffff;
            background: #1a1a1a;
        }
        
        .nav-item.active {
            background: #333;
            color: #ffffff;
            border-left: 4px solid #ffffff;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 0;
            min-height: calc(100vh - 80px);
            background: #0a0a0a;
            padding-bottom: 100px; /* Add padding for player */
        }
        
        .header {
            background: #111;
            border-bottom: 2px solid #333;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-bar {
            background: #000;
            border: 2px solid #333;
            padding: 12px 16px;
            color: #fff;
            width: 400px;
            max-width: 100%;
            font-size: 13px;
            font-family: inherit;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: #666;
        }
        
        .search-bar::placeholder {
            color: #666;
        }
        
        .sort-select {
            background: #000;
            color: #fff;
            border: 2px solid #333;
            padding: 12px 16px;
            font-size: 13px;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }
        
        .sort-select:focus {
            outline: none;
            border-color: #666;
        }
        
        .session-status {
            font-size: 10px;
            padding: 8px 12px;
            border: 1px solid;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
            white-space: nowrap;
        }
        
        .session-active {
            color: #1db954;
            border-color: #1db954;
            background: rgba(29, 185, 84, 0.1);
        }
        
        .session-inactive {
            color: #888;
            border-color: #444;
            background: rgba(68, 68, 68, 0.1);
        }
        
        .sort-select option {
            background: #000;
            color: #fff;
        }
        
        .btn {
            background: #ffffff;
            color: #000000;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: none;
            white-space: nowrap;
        }
        
        .btn:hover {
            background: #cccccc;
        }
        
        .btn-secondary {
            background: #333;
            color: #fff;
            border: 1px solid #666;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-danger {
            background: #000;
            color: #fff;
            border: 1px solid #666;
        }
        
        .btn-danger:hover {
            background: #333;
        }
        
        /* Download Interface Styles */
        .download-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .download-form h3 {
            margin-bottom: 20px;
            color: #1db954;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .url-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #1db954;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .url-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-download {
            background: #1db954;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }
        
        .btn-download:hover {
            background: #1ed760;
            transform: translateY(-1px);
        }
        
        .btn-download:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .download-jobs {
            margin-top: 30px;
        }
        
        .download-job {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .download-job:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .job-title {
            font-weight: 500;
            color: #fff;
            font-size: 14px;
        }
        
        .job-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .status-downloading {
            background: rgba(13, 202, 240, 0.2);
            color: #0dcaf0;
            border: 1px solid rgba(13, 202, 240, 0.3);
        }
        
        .status-completed {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
            border: 1px solid rgba(25, 135, 84, 0.3);
        }
        
        .status-failed {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .job-url {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            word-break: break-all;
        }
        
        .job-progress-container {
            display: none;
            margin-bottom: 10px;
        }
        
        .job-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .job-progress-fill {
            height: 100%;
            background: #1db954;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .job-progress-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        .job-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            padding: 8px 12px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .download-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1db954;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        .no-downloads {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }
        
        .refresh-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            border-color: #1db954;
            color: #1db954;
        }
        
        /* Search Interface Styles */
        .search-container {
            margin-bottom: 30px;
        }
        
        .search-container input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .search-container input:focus {
            border-color: #1db954;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
        }
        
        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .content-area {
            padding: 30px;
            padding-bottom: 50px; /* Extra padding at bottom for player */
        }
        
        .section-title {
            font-size: 18px;
            font-weight: normal;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #ffffff;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .track-grid {
            display: grid;
            gap: 2px;
            background: #333;
        }
        
        .track-item {
            background: #111;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #1a1a1a;
            transition: none;
            flex-wrap: wrap;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .track-item:hover {
            background: #1a1a1a;
        }
        
        .track-item:active {
            background: #222;
        }
        
        .track-item.playing {
            background: #1a1a1a;
            border-left: 4px solid #ffffff;
        }
        
        .track-item.playing .track-title {
            color: #ffffff;
        }
        
        .track-info {
            flex-grow: 1;
            min-width: 200px;
        }
        
        .track-title {
            font-size: 14px;
            font-weight: normal;
            margin-bottom: 4px;
            color: #ffffff;
            word-break: break-word;
        }
        
        .track-artist {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            word-break: break-word;
        }
        
        .track-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .play-btn {
            background: #ffffff;
            color: #000000;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .play-btn:hover {
            background: #cccccc;
        }
        
        .add-to-playlist-btn {
            background: #000;
            color: #fff;
            border: 1px solid #333;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .add-to-playlist-btn:hover {
            border-color: #666;
        }
        
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 2px solid #333;
            z-index: 1001;
            height: auto;
            min-height: 80px;
        }
        
        .player-content {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 280px;
            padding: 15px 20px;
            flex-wrap: wrap;
        }
        
        .now-playing {
            min-width: 200px;
            max-width: 300px;
            flex-shrink: 0;
        }
        
        .now-playing-title {
            font-weight: normal;
            font-size: 13px;
            color: #ffffff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .now-playing-artist {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            border-color: #666;
            background: #111;
        }
        
        .control-btn.active {
            border-color: #1db954;
            color: #1db954;
        }
        
        .play-pause-btn {
            background: #1db954;
            border: 1px solid #1db954;
            color: #000;
            font-weight: bold;
            min-width: 50px;
            height: 50px;
            font-size: 16px;
        }
        
        .play-pause-btn:hover {
            background: #1ed760;
            border-color: #1ed760;
        }
        
        .progress-container {
            flex-grow: 1;
            min-width: 200px;
            margin: 0 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #1db954;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: #888;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: #333;
            cursor: pointer;
            position: relative;
        }
        
        .volume-fill {
            height: 100%;
            background: #1db954;
            width: 100%;
        }
        
        audio {
            display: none;
        }
        
        .playlist-container {
            display: grid;
            gap: 2px;
            background: #333;
            margin-top: 20px;
        }
        
        .playlist-item {
            background: #111;
            padding: 20px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            transition: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .playlist-item:hover {
            background: #1a1a1a;
        }
        
        .playlist-meta {
            flex-grow: 1;
            min-width: 200px;
        }
        
        .playlist-name {
            font-size: 14px;
            font-weight: normal;
            margin-bottom: 6px;
            color: #ffffff;
            word-break: break-word;
        }
        
        .playlist-info {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .playlist-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            background: #111;
            margin: 10% auto;
            padding: 0;
            border: 2px solid #333;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #000;
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal h2 {
            color: #fff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: normal;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            background: #000;
            border: 2px solid #333;
            padding: 12px 16px;
            color: #fff;
            font-size: 13px;
            font-family: inherit;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #666;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #333;
            flex-wrap: wrap;
        }
        
        .close {
            color: #888;
            font-size: 20px;
            font-weight: normal;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .stats {
            color: #666;
            margin-bottom: 30px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 15px;
            background: #111;
            border: 1px solid #1a1a1a;
        }
        
        .loading {
            color: #666;
            padding: 60px 20px;
            text-align: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: #111;
            border: 1px solid #1a1a1a;
        }
        
        .playlist-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .back-btn {
            background: #000;
            color: #fff;
            border: 1px solid #333;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .back-btn:hover {
            border-color: #666;
        }
        
        /* Remove all rounded corners and smooth transitions */
        *, *::before, *::after {
            border-radius: 0 !important;
            transition: none !important;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            body {
                font-size: 12px;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-280px);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding-bottom: 120px; /* More padding for mobile player */
            }
            
            .header {
                padding: 15px;
                padding-top: 60px; /* Space for mobile menu button */
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-bar {
                width: 100%;
            }
            
            .sort-select {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .content-area {
                padding: 20px 15px;
                padding-bottom: 60px;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 20px;
            }
            
            .track-item {
                padding: 12px 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .track-info {
                min-width: auto;
                text-align: center;
            }
            
            .track-actions {
                justify-content: center;
                width: 100%;
            }
            
            .playlist-item {
                padding: 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .playlist-meta {
                min-width: auto;
                text-align: center;
            }
            
            .playlist-actions {
                justify-content: center;
                width: 100%;
            }
            
            .player {
                height: auto;
                min-height: 120px;
            }
            
            .player-content {
                margin-left: 0;
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }
            
            .now-playing {
                min-width: auto;
                max-width: none;
                text-align: center;
                width: 100%;
            }
            
            .now-playing-title, .now-playing-artist {
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                word-break: break-word;
            }
            
            .audio-controls {
                order: 2;
                justify-content: center;
                width: 100%;
                flex-wrap: nowrap;
                gap: 10px;
            }
            
            .control-btn {
                min-width: 44px;
                height: 44px;
                font-size: 16px;
            }
            
            .play-pause-btn {
                min-width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            .progress-container {
                order: 1;
                margin: 0;
                width: 100%;
            }
            
            .volume-container {
                order: 3;
                justify-content: center;
                width: 100%;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
                max-height: 90vh;
            }
            
            .modal-header, .modal-body {
                padding: 20px 15px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
            
            .playlist-detail-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
        }
        
        /* Smaller mobile devices */
        @media (max-width: 480px) {
            .content-area {
                padding: 15px 10px;
            }
            
            .track-item, .playlist-item {
                padding: 10px;
            }
            
            .track-actions, .playlist-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .play-btn, .add-to-playlist-btn, .btn-secondary, .btn-danger {
                width: 100%;
                text-align: center;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .nav-item, .track-item, .playlist-item, .btn, .play-btn, .add-to-playlist-btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .track-actions, .playlist-actions {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
    
    <div class="sidebar" id="sidebar">
        <div class="logo">nonameyet</div>
        <nav>
            <a href="#" class="nav-item active" onclick="showSection('library')">LIBRARY</a>
            <a href="#" class="nav-item" onclick="showSection('playlists')">PLAYLISTS</a>
            <a href="#" class="nav-item" onclick="showSection('search')">SEARCH</a>
            <a href="#" class="nav-item" onclick="showSection('downloads')">DOWNLOADS</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-controls">
                <input type="text" id="searchInput" class="search-bar" placeholder="SEARCH TRACKS..." oninput="handleSearch(event)">
                <select id="sortSelect" class="sort-select" onchange="handleSortChange(event)">
                    <option value="default">SORT: ARTIST/ALBUM</option>
                    <option value="album">SORT: ALBUM</option>
                </select>
                <div id="session-status" class="session-status session-inactive">CONNECTING...</div>
            </div>
            <button class="btn" onclick="showCreatePlaylistModal()">NEW PLAYLIST</button>
        </div>

        <div id="library-section">
            <div class="content-area">
                <h2 class="section-title">MUSIC LIBRARY</h2>
                <div class="stats" id="stats">LOADING...</div>
                <div class="track-grid" id="tracks"></div>
            </div>
        </div>

        <div id="playlists-section" style="display: none;">
            <div class="content-area">
                <h2 class="section-title">PLAYLISTS</h2>
                <div class="playlist-container" id="playlists"></div>
            </div>
        </div>

        <div id="playlist-detail-section" style="display: none;">
            <div class="content-area">
                <div class="playlist-detail-header">
                    <h2 class="section-title" id="playlist-detail-title">PLAYLIST</h2>
                    <button class="back-btn" onclick="showSection('playlists')">← BACK</button>
                </div>
                <div class="track-grid" id="playlist-tracks"></div>
            </div>
        </div>

        <div id="search-section" style="display: none;">
            <div class="content-area">
                <h2 class="section-title">SEARCH MUSIC</h2>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search your music library..." oninput="performSearch(event)">
                </div>
                <div class="track-grid" id="search-results"></div>
            </div>
        </div>

        <div id="downloads-section" style="display: none;">
            <div class="content-area">
                <h2 class="section-title">MUSIC DOWNLOADS</h2>
                
                <!-- Download Form -->
                <div class="download-form">
                    <h3>Add New Music</h3>
                    <div class="url-input-group">
                        <input type="text" id="downloadUrl" class="url-input" 
                               placeholder="Enter URL (YouTube, SoundCloud, etc.)" 
                               onkeyup="handleDownloadInput(event)">
                        <button type="button" class="btn-download" onclick="startDownload()">
                            Download
                        </button>
                    </div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 10px;">
                        Supports YouTube, SoundCloud, and 500+ other sites via yt-dlp
                    </div>
                </div>

                <!-- Download Statistics -->
                <div class="download-stats" id="downloadStats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalDownloads">-</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="activeDownloads">-</span>
                        <span class="stat-label">Active</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completedDownloads">-</span>
                        <span class="stat-label">Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="failedDownloads">-</span>
                        <span class="stat-label">Failed</span>
                    </div>
                </div>

                <!-- Download Jobs Header -->
                <div class="download-jobs">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #fff; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">
                            Download Queue
                        </h3>
                        <button class="refresh-btn" onclick="refreshDownloadJobs()">
                            ↻ Refresh
                        </button>
                    </div>
                    
                    <!-- Download Jobs List -->
                    <div id="downloadJobs">
                        <div class="no-downloads">
                            No downloads yet. Add a URL above to get started!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="player" id="player" style="display: none;">
        <div class="player-content">
            <div class="now-playing" id="nowPlaying">
                <div class="now-playing-title" id="nowPlayingTitle">NOT PLAYING</div>
                <div class="now-playing-artist" id="nowPlayingArtist">---</div>
            </div>
            
            <div class="audio-controls">
                <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
                    <i class="nf nf-md-shuffle"></i>
                </button>
                <button class="control-btn" onclick="playPreviousTrack()" title="Previous">
                    <i class="nf nf-md-skip_previous"></i>
                </button>
                <button class="play-pause-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">
                    <i class="nf nf-md-pause"></i>
                </button>
                <button class="control-btn" onclick="playNextTrack()" title="Next">
                    <i class="nf nf-md-skip_next"></i>
                </button>
                <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat Off">
                    <i class="nf nf-md-repeat"></i>
                </button>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" onclick="seekToPosition(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            
            <div class="volume-container">
                <button class="control-btn" id="volumeBtn" onclick="toggleMute()" title="Volume">
                    <i class="nf nf-md-volume_high"></i>
                </button>
                <div class="volume-slider" id="volumeSlider" onclick="setVolume(event)">
                    <div class="volume-fill" id="volumeFill"></div>
                </div>
            </div>
            
            <audio id="audioPlayer"></audio>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div id="createPlaylistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CREATE PLAYLIST</h2>
                <span class="close" onclick="closeCreatePlaylistModal()">×</span>
            </div>
            <div class="modal-body">
                <form onsubmit="createPlaylist(event)">
                    <div class="form-group">
                        <label for="playlistName">NAME</label>
                        <input type="text" id="playlistName" required>
                    </div>
                    <div class="form-group">
                        <label for="playlistDescription">DESCRIPTION</label>
                        <textarea id="playlistDescription"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreatePlaylistModal()">CANCEL</button>
                        <button type="submit" class="btn">CREATE</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="addToPlaylistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ADD TO PLAYLIST</h2>
                <span class="close" onclick="closeAddToPlaylistModal()">×</span>
            </div>
            <div class="modal-body">
                <div id="playlistOptions"></div>
            </div>
        </div>
    </div>

    <script>
        let tracks = [];
        let playlists = [];
        let currentSection = 'library';
        let currentPlaylistId = null;
        let selectedTrackId = null;
        let lastTrackCount = 0;
        let updateInterval;
        let currentTrackList = []; // Stores the current list of tracks being played
        let currentTrackIndex = -1; // Index of currently playing track in the list
        let currentTrackId = null; // ID of currently playing track
        let sessionId = null; // Current session ID
        let isActiveSession = false; // Whether this is the active session
        
        // Player state variables
        let isShuffled = false;
        let repeatMode = 0; // 0 = off, 1 = playlist, 2 = track
        let isMuted = false;
        let lastVolume = 1;
        
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });
        
        // Close sidebar when window is resized to desktop
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
            }
        });
        
        // Session management
        async function createSession() {
            try {
                const deviceName = getDeviceName();
                const response = await fetch('/api/sessions/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceName: deviceName })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sessionId = data.sessionId;
                    isActiveSession = data.isActive;
                    console.log(`📱 Session created: ${sessionId} (${deviceName})${isActiveSession ? ' - ACTIVE' : ''}`);
                    
                    // Update UI to show session status
                    updateSessionStatus();
                } else {
                    console.error('Failed to create session');
                }
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }
        
        // Get device name based on user agent
        function getDeviceName() {
            const ua = navigator.userAgent.toLowerCase();
            
            if (ua.includes('mobile') || ua.includes('android')) {
                if (ua.includes('android')) return 'Android Device';
                return 'Mobile Device';
            }
            if (ua.includes('iphone')) return 'iPhone';
            if (ua.includes('ipad')) return 'iPad';
            if (ua.includes('mac') || ua.includes('macintosh')) return 'Mac';
            if (ua.includes('windows')) return 'Windows PC';
            if (ua.includes('linux')) return 'Linux PC';
            
            return 'Web Browser';
        }
        
        // Update session status in UI
        function updateSessionStatus() {
            // You can add a visual indicator here
            const statusElement = document.getElementById('session-status');
            if (statusElement) {
                statusElement.textContent = isActiveSession ? 'CONTROLLING DISCORD' : 'BACKGROUND SESSION';
                statusElement.className = isActiveSession ? 'session-active' : 'session-inactive';
            }
        }
        
        // Check if other sessions are active
        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const data = await response.json();
                    const wasActive = isActiveSession;
                    isActiveSession = data.activeSessionId === sessionId;
                    
                    if (wasActive !== isActiveSession) {
                        console.log(`🎮 Session status changed: ${isActiveSession ? 'ACTIVE' : 'INACTIVE'}`);
                        updateSessionStatus();
                    }
                }
            } catch (error) {
                console.error('Error checking session status:', error);
            }
        }

        // Discord RPC integration
        let discordUpdateTimeout;
        
        // Update Discord RPC with current state (session-aware)
        async function updateDiscordRPC() {
            if (!sessionId) {
                console.warn('No session ID available for Discord RPC update');
                return;
            }
            
            // Debounce rapid updates
            clearTimeout(discordUpdateTimeout);
            discordUpdateTimeout = setTimeout(async () => {
                try {
                    const audioPlayer = document.getElementById('audioPlayer');
                    const state = {
                        sessionId: sessionId,
                        isPlaying: !audioPlayer.paused && !!audioPlayer.src,
                        currentTime: Math.floor(audioPlayer.currentTime || 0),
                        totalDuration: Math.floor(audioPlayer.duration || 0),
                        volume: audioPlayer.volume || 1.0,
                        isMuted: isMuted,
                        isShuffled: isShuffled,
                        repeatMode: repeatMode
                    };
                    
                    // Include track ID if we have one
                    if (currentTrackId !== null) {
                        state.trackId = currentTrackId;
                    }
                    
                    console.log('Sending session Discord RPC update:', state);
                    
                    const response = await fetch('/api/sessions/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        isActiveSession = data.isActive;
                        updateSessionStatus();
                    } else {
                        console.error('Session Discord RPC update failed:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Failed to update session Discord RPC:', error);
                }
            }, 500); // Wait 500ms before sending update
        }

        // Initialize the app
        async function init() {
            // Create session first
            await createSession();
            
            await loadTracks();
            await loadPlaylists();
            startTrackCountMonitoring();
            setupKeyboardShortcuts();
            
            // Start checking session status periodically
            setInterval(checkSessionStatus, 10000); // Check every 10 seconds
        }
        
        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Only handle shortcuts when not typing in an input field
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(event.code) {
                    case 'ArrowRight':
                    case 'KeyN':
                        event.preventDefault();
                        playNextTrack();
                        break;
                    case 'ArrowLeft':
                    case 'KeyP':
                        event.preventDefault();
                        playPreviousTrack();
                        break;
                    case 'Space':
                        event.preventDefault();
                        togglePlayPause();
                        break;
                }
            });
        }
        
        // Toggle play/pause
        function togglePlayPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const icon = playPauseBtn.querySelector('i');
            
            if (audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    icon.className = 'nf nf-md-pause';
                } else {
                    audioPlayer.pause();
                    icon.className = 'nf nf-md-play';
                }
                updateDiscordRPC(); // Update Discord RPC on play/pause
            }
        }
        
        // Toggle shuffle mode
        function toggleShuffle() {
            isShuffled = !isShuffled;
            const shuffleBtn = document.getElementById('shuffleBtn');
            
            if (isShuffled) {
                shuffleBtn.classList.add('active');
                shuffleBtn.title = 'Shuffle On';
            } else {
                shuffleBtn.classList.remove('active');
                shuffleBtn.title = 'Shuffle Off';
            }
            updateDiscordRPC(); // Update Discord RPC when shuffle changes
        }
        
        // Toggle repeat mode (off -> playlist -> track -> off)
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const repeatBtn = document.getElementById('repeatBtn');
            const icon = repeatBtn.querySelector('i');
            
            switch (repeatMode) {
                case 0:
                    repeatBtn.classList.remove('active');
                    icon.className = 'nf nf-md-repeat';
                    repeatBtn.title = 'Repeat Off';
                    break;
                case 1:
                    repeatBtn.classList.add('active');
                    icon.className = 'nf nf-md-repeat';
                    repeatBtn.title = 'Repeat Playlist';
                    break;
                case 2:
                    repeatBtn.classList.add('active');
                    icon.className = 'nf nf-md-repeat_once';
                    repeatBtn.title = 'Repeat Track';
                    break;
            }
            updateDiscordRPC(); // Update Discord RPC when repeat changes
        }
        
        // Toggle mute
        function toggleMute() {
            const audioPlayer = document.getElementById('audioPlayer');
            const volumeBtn = document.getElementById('volumeBtn');
            const volumeFill = document.getElementById('volumeFill');
            const icon = volumeBtn.querySelector('i');
            
            if (isMuted) {
                audioPlayer.volume = lastVolume;
                volumeFill.style.width = (lastVolume * 100) + '%';
                icon.className = lastVolume > 0.5 ? 'nf nf-md-volume_high' : 'nf nf-md-volume_medium';
                isMuted = false;
            } else {
                lastVolume = audioPlayer.volume;
                audioPlayer.volume = 0;
                volumeFill.style.width = '0%';
                icon.className = 'nf nf-md-volume_off';
                isMuted = true;
            }
            updateDiscordRPC(); // Update Discord RPC when volume changes
        }
        
        // Set volume from slider click
        function setVolume(event) {
            const volumeSlider = event.currentTarget;
            const rect = volumeSlider.getBoundingClientRect();
            const percentage = (event.clientX - rect.left) / rect.width;
            const volume = Math.max(0, Math.min(1, percentage));
            
            const audioPlayer = document.getElementById('audioPlayer');
            const volumeFill = document.getElementById('volumeFill');
            const volumeBtn = document.getElementById('volumeBtn');
            const icon = volumeBtn.querySelector('i');
            
            audioPlayer.volume = volume;
            volumeFill.style.width = (volume * 100) + '%';
            
            if (volume === 0) {
                icon.className = 'nf nf-md-volume_off';
                isMuted = true;
            } else {
                icon.className = volume > 0.5 ? 'nf nf-md-volume_high' : 'nf nf-md-volume_medium';
                isMuted = false;
                lastVolume = volume;
            }
            updateDiscordRPC(); // Update Discord RPC when volume changes
        }
        
        // Seek to position in track
        function seekToPosition(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percentage = (event.clientX - rect.left) / rect.width;
            const audioPlayer = document.getElementById('audioPlayer');
            
            if (audioPlayer.duration) {
                audioPlayer.currentTime = audioPlayer.duration * percentage;
            }
        }
        
        // Format time for display
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Update progress bar and time display
        function updateProgress() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progressFill = document.getElementById('progressFill');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            
            if (audioPlayer.duration) {
                const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percentage + '%';
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
                totalTimeSpan.textContent = formatTime(audioPlayer.duration);
                
                // Update Discord RPC periodically (every 10 seconds) to sync progress
                if (Math.floor(audioPlayer.currentTime) % 10 === 0) {
                    updateDiscordRPC();
                }
            }
        }
        
        // Monitor for new tracks
        function startTrackCountMonitoring() {
            updateInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/tracks/count');
                    const data = await response.json();
                    
                    if (data.count !== lastTrackCount && lastTrackCount > 0) {
                        console.log(`Track count changed: ${lastTrackCount} -> ${data.count}`);
                        await loadTracks(); // Reload tracks if count changed
                        
                        if (data.count > lastTrackCount) {
                            showNotification('NEW TRACK ADDED');
                        }
                    }
                    lastTrackCount = data.count;
                } catch (error) {
                    console.error('Error checking track count:', error);
                }
            }, 2000); // Check every 2 seconds
        }
        
        function showNotification(message) {
            // Simple notification in console for now
            console.log(`[NOTIFICATION] ${message}`);
            
            // Update stats to show the notification
            const stats = document.getElementById('stats');
            const originalText = stats.textContent;
            stats.textContent = message;
            stats.style.color = '#ffffff';
            
            setTimeout(() => {
                stats.textContent = originalText;
                stats.style.color = '#666';
            }, 3000);
        }
        
        // Load all tracks
        async function loadTracks(sortBy = null) {
            try {
                let url = '/api/tracks';
                if (sortBy) {
                    url += '?sort=' + sortBy;
                }
                const response = await fetch(url);
                tracks = await response.json();
                displayTracks();
                updateStats();
            } catch (error) {
                console.error('Error loading tracks:', error);
                document.getElementById('stats').textContent = 'ERROR LOADING LIBRARY';
            }
        }
        
        // Load all playlists
        async function loadPlaylists() {
            try {
                const response = await fetch('/api/playlists');
                playlists = await response.json();
                displayPlaylists();
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        }
        
        // Update stats display
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `${tracks.length} TRACKS INDEXED`;
        }
        
        // Display tracks in the library
        function displayTracks(tracksToShow = tracks) {
            const tracksContainer = document.getElementById('tracks');
            tracksContainer.innerHTML = '';
            
            tracksToShow.forEach((track, index) => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track-item';
                trackDiv.style.cursor = 'pointer';
                
                // Format track number for display
                const trackNumDisplay = track.trackNumber > 0 ? track.trackNumber.toString().padStart(2, '0') + '. ' : '';
                
                trackDiv.innerHTML = `
                    <div class="track-info">
                        <div class="track-title">${trackNumDisplay}${escapeHtml(track.title)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)} • ${escapeHtml(track.album)}</div>
                    </div>
                    <div class="track-actions">
                        <button class="play-btn" onclick="event.stopPropagation(); playTrack(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artist)}', ${index})">PLAY</button>
                        <button class="add-to-playlist-btn" onclick="event.stopPropagation(); showAddToPlaylistModal(${track.id})">ADD</button>
                    </div>
                `;
                
                // Make entire track item clickable
                trackDiv.onclick = () => playTrack(track.id, track.title, track.artist, index);
                
                tracksContainer.appendChild(trackDiv);
            });
            
            if (tracksToShow.length === 0) {
                tracksContainer.innerHTML = '<div class="loading">NO TRACKS FOUND</div>';
            }
            
            // Update current track list for auto-play functionality
            currentTrackList = tracksToShow;
        }
        
        // Display playlists
        function displayPlaylists() {
            const playlistsContainer = document.getElementById('playlists');
            playlistsContainer.innerHTML = '';
            
            playlists.forEach(playlist => {
                const playlistDiv = document.createElement('div');
                playlistDiv.className = 'playlist-item';
                playlistDiv.innerHTML = `
                    <div class="playlist-meta">
                        <div class="playlist-name">${escapeHtml(playlist.name)}</div>
                        <div class="playlist-info">${playlist.trackCount} TRACKS • ${new Date(playlist.createdAt).toLocaleDateString().toUpperCase()}</div>
                        ${playlist.description ? `<div class="playlist-info">${escapeHtml(playlist.description)}</div>` : ''}
                    </div>
                    <div class="playlist-actions">
                        <button class="btn-secondary" onclick="showPlaylistDetail(${playlist.id}, '${escapeHtml(playlist.name)}')">OPEN</button>
                        <button class="btn-danger" onclick="deletePlaylist(${playlist.id})">DELETE</button>
                    </div>
                `;
                playlistsContainer.appendChild(playlistDiv);
            });
            
            if (playlists.length === 0) {
                playlistsContainer.innerHTML = '<div class="loading">NO PLAYLISTS CREATED</div>';
            }
        }
        
        // Show playlist detail
        async function showPlaylistDetail(playlistId, playlistName) {
            currentPlaylistId = playlistId;
            document.getElementById('playlist-detail-title').textContent = playlistName.toUpperCase();
            
            try {
                const response = await fetch(`/api/playlists/${playlistId}/tracks`);
                const playlistTracks = await response.json();
                
                const container = document.getElementById('playlist-tracks');
                container.innerHTML = '';
                
                playlistTracks.forEach((track, index) => {
                    const trackDiv = document.createElement('div');
                    trackDiv.className = 'track-item';
                    trackDiv.style.cursor = 'pointer';
                    
                    // Format track number for display
                    const trackNumDisplay = track.trackNumber > 0 ? track.trackNumber.toString().padStart(2, '0') + '. ' : '';
                    
                    trackDiv.innerHTML = `
                        <div class="track-info">
                            <div class="track-title">${trackNumDisplay}${escapeHtml(track.title)}</div>
                            <div class="track-artist">${escapeHtml(track.artist)} • ${escapeHtml(track.album)}</div>
                        </div>
                        <div class="track-actions">
                            <button class="play-btn" onclick="event.stopPropagation(); playTrack(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artist)}', ${index})">PLAY</button>
                            <button class="btn-danger" onclick="event.stopPropagation(); removeFromPlaylist(${playlistId}, ${track.id})">REMOVE</button>
                        </div>
                    `;
                    
                    // Make entire track item clickable
                    trackDiv.onclick = () => playTrack(track.id, track.title, track.artist, index);
                    
                    container.appendChild(trackDiv);
                });
                
                if (playlistTracks.length === 0) {
                    container.innerHTML = '<div class="loading">EMPTY PLAYLIST</div>';
                }
                
                // Update current track list for auto-play functionality
                currentTrackList = playlistTracks;
                
                showSection('playlist-detail');
            } catch (error) {
                console.error('Error loading playlist tracks:', error);
            }
        }
        
        // Play a track
        async function playTrack(trackId, title, artist, trackIndex = -1) {
            const player = document.getElementById('player');
            const audioPlayer = document.getElementById('audioPlayer');
            const nowPlayingTitle = document.getElementById('nowPlayingTitle');
            const nowPlayingArtist = document.getElementById('nowPlayingArtist');
            const playPauseBtn = document.getElementById('playPauseBtn');
            
            // Remove playing class from all tracks
            document.querySelectorAll('.track-item.playing').forEach(item => {
                item.classList.remove('playing');
            });
            
            // Add playing class to current track if trackIndex is valid
            if (trackIndex >= 0) {
                const trackItems = document.querySelectorAll('.track-item');
                if (trackItems[trackIndex]) {
                    trackItems[trackIndex].classList.add('playing');
                }
            }
            
            // Set current track index and ID
            currentTrackIndex = trackIndex;
            currentTrackId = trackId;
            
            audioPlayer.src = `/stream/${trackId}`;
            nowPlayingTitle.textContent = title.toUpperCase();
            nowPlayingArtist.textContent = artist.toUpperCase();
            player.style.display = 'block';
            
            // Remove existing event listeners to prevent duplicates
            audioPlayer.removeEventListener('ended', handleTrackEnded);
            audioPlayer.removeEventListener('timeupdate', updateProgress);
            audioPlayer.removeEventListener('loadedmetadata', updateProgress);
            
            // Add event listeners
            audioPlayer.addEventListener('ended', handleTrackEnded);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateProgress);
            
            // Notify backend about track play
            try {
                await fetch(`/api/player/play/${trackId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.error('Failed to notify backend about track play:', error);
            }
            
            audioPlayer.play().then(() => {
                const icon = playPauseBtn.querySelector('i');
                icon.className = 'nf nf-md-pause';
                updateDiscordRPC(); // Update Discord RPC when track starts
            }).catch(error => {
                console.error('Error playing track:', error);
                const icon = playPauseBtn.querySelector('i');
                icon.className = 'nf nf-md-play';
            });
            
            // Close sidebar on mobile after playing
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }
        
        // Clear current track info (when stopping playback)
        function clearCurrentTrack() {
            currentTrackId = null;
            currentTrackIndex = -1;
            updateDiscordRPC(); // Update Discord to show idle state
        }
        
        // Handle track ended - play next track automatically
        function handleTrackEnded() {
            if (repeatMode === 2) {
                // Repeat current track
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                playNextTrack();
            }
        }
        
        // Get next track index considering shuffle mode
        function getNextTrackIndex() {
            if (currentTrackList.length === 0 || currentTrackIndex === -1) {
                return -1;
            }
            
            if (isShuffled) {
                // Get random track that's not the current one
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * currentTrackList.length);
                } while (randomIndex === currentTrackIndex && currentTrackList.length > 1);
                return randomIndex;
            } else {
                const nextIndex = currentTrackIndex + 1;
                if (nextIndex < currentTrackList.length) {
                    return nextIndex;
                } else if (repeatMode === 1) {
                    // Repeat playlist
                    return 0;
                }
                return -1;
            }
        }
        
        // Get previous track index
        function getPreviousTrackIndex() {
            if (currentTrackList.length === 0 || currentTrackIndex === -1) {
                return -1;
            }
            
            if (isShuffled) {
                // For shuffle, just pick a random track
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * currentTrackList.length);
                } while (randomIndex === currentTrackIndex && currentTrackList.length > 1);
                return randomIndex;
            } else {
                const prevIndex = currentTrackIndex - 1;
                if (prevIndex >= 0) {
                    return prevIndex;
                } else if (repeatMode === 1) {
                    // Go to last track if repeat playlist is on
                    return currentTrackList.length - 1;
                }
                return -1;
            }
        }
        
        // Play next track in the current list
        function playNextTrack() {
            const nextIndex = getNextTrackIndex();
            
            if (nextIndex >= 0) {
                const nextTrack = currentTrackList[nextIndex];
                console.log(`Playing next track: ${nextTrack.title} by ${nextTrack.artist}`);
                playTrack(nextTrack.id, nextTrack.title, nextTrack.artist, nextIndex);
            } else {
                console.log('Reached end of track list');
                const playPauseBtn = document.getElementById('playPauseBtn');
                const icon = playPauseBtn.querySelector('i');
                icon.className = 'nf nf-md-play';
            }
        }
        
        // Play previous track in the current list
        function playPreviousTrack() {
            const prevIndex = getPreviousTrackIndex();
            
            if (prevIndex >= 0) {
                const prevTrack = currentTrackList[prevIndex];
                console.log(`Playing previous track: ${prevTrack.title} by ${prevTrack.artist}`);
                playTrack(prevTrack.id, prevTrack.title, prevTrack.artist, prevIndex);
            } else {
                console.log('Already at the beginning of track list');
            }
        }
        
        // Show different sections
        function showSection(section) {
            // Hide all sections
            document.getElementById('library-section').style.display = 'none';
            document.getElementById('playlists-section').style.display = 'none';
            document.getElementById('playlist-detail-section').style.display = 'none';
            document.getElementById('search-section').style.display = 'none';
            document.getElementById('downloads-section').style.display = 'none';
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Show selected section
            if (section === 'library') {
                document.getElementById('library-section').style.display = 'block';
                document.querySelector('[onclick="showSection(\'library\')"]').classList.add('active');
            } else if (section === 'playlists') {
                document.getElementById('playlists-section').style.display = 'block';
                document.querySelector('[onclick="showSection(\'playlists\')"]').classList.add('active');
            } else if (section === 'search') {
                document.getElementById('search-section').style.display = 'block';
                document.querySelector('[onclick="showSection(\'search\')"]').classList.add('active');
            } else if (section === 'downloads') {
                document.getElementById('downloads-section').style.display = 'block';
                document.querySelector('[onclick="showSection(\'downloads\')"]').classList.add('active');
                // Load download jobs when section is shown
                refreshDownloadJobs();
            } else if (section === 'playlist-detail') {
                document.getElementById('playlist-detail-section').style.display = 'block';
            }
            
            currentSection = section;
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }
        
        let searchTimeout;
        
        // Handle search
        function handleSearch(event) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = event.target.value.toLowerCase();
                if (query === '') {
                    displayTracks();
                } else {
                    const filteredTracks = tracks.filter(track =>
                        track.title.toLowerCase().includes(query) ||
                        track.artist.toLowerCase().includes(query) ||
                        track.album.toLowerCase().includes(query)
                    );
                    displayTracks(filteredTracks);
                }
            }, 150); // 150ms debounce
        }
        
        // Handle sort change
        function handleSortChange(event) {
            const sortBy = event.target.value;
            loadTracks(sortBy === 'default' ? null : sortBy);
        }
        
        // Create playlist modal functions
        function showCreatePlaylistModal() {
            document.getElementById('createPlaylistModal').style.display = 'block';
        }
        
        function closeCreatePlaylistModal() {
            document.getElementById('createPlaylistModal').style.display = 'none';
            document.getElementById('playlistName').value = '';
            document.getElementById('playlistDescription').value = '';
        }
        
        // Create playlist
        async function createPlaylist(event) {
            event.preventDefault();
            
            const name = document.getElementById('playlistName').value;
            const description = document.getElementById('playlistDescription').value;
            
            try {
                const response = await fetch('/api/playlists/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, description }),
                });
                
                if (response.ok) {
                    closeCreatePlaylistModal();
                    await loadPlaylists();
                    if (currentSection === 'playlists') {
                        displayPlaylists();
                    }
                } else {
                    alert('Error creating playlist');
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert('Error creating playlist');
            }
        }
        
        // Add to playlist modal functions
        function showAddToPlaylistModal(trackId) {
            selectedTrackId = trackId;
            const modal = document.getElementById('addToPlaylistModal');
            const options = document.getElementById('playlistOptions');
            
            options.innerHTML = '';
            playlists.forEach(playlist => {
                const option = document.createElement('div');
                option.className = 'playlist-item';
                option.onclick = () => addToPlaylist(playlist.id);
                option.innerHTML = `
                    <div class="playlist-meta">
                        <div class="playlist-name">${escapeHtml(playlist.name)}</div>
                        <div class="playlist-info">${playlist.trackCount} TRACKS</div>
                    </div>
                `;
                options.appendChild(option);
            });
            
            if (playlists.length === 0) {
                options.innerHTML = '<div class="loading">NO PLAYLISTS AVAILABLE</div>';
            }
            
            modal.style.display = 'block';
        }
        
        function closeAddToPlaylistModal() {
            document.getElementById('addToPlaylistModal').style.display = 'none';
            selectedTrackId = null;
        }
        
        // Delete playlist
        async function deletePlaylist(playlistId) {
            if (!confirm('DELETE THIS PLAYLIST?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/playlists/${playlistId}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    await loadPlaylists();
                    displayPlaylists();
                } else {
                    alert('ERROR DELETING PLAYLIST');
                }
            } catch (error) {
                console.error('Error deleting playlist:', error);
                alert('ERROR DELETING PLAYLIST');
            }
        }
        
        // Add track to playlist
        async function addToPlaylist(playlistId) {
            try {
                const response = await fetch(`/api/playlists/${playlistId}/tracks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trackId: selectedTrackId }),
                });
                
                if (response.ok) {
                    closeAddToPlaylistModal();
                    await loadPlaylists(); // Refresh to update track counts
                } else {
                    alert('Error adding track to playlist');
                }
            } catch (error) {
                console.error('Error adding to playlist:', error);
                alert('Error adding track to playlist');
            }
        }
        
        // Remove track from playlist
        async function removeFromPlaylist(playlistId, trackId) {
            try {
                const response = await fetch(`/api/playlists/${playlistId}/tracks/${trackId}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    showPlaylistDetail(playlistId, document.getElementById('playlist-detail-title').textContent);
                    await loadPlaylists(); // Refresh to update track counts
                } else {
                    alert('Error removing track from playlist');
                }
            } catch (error) {
                console.error('Error removing from playlist:', error);
                alert('Error removing track from playlist');
            }
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createPlaylistModal');
            const addModal = document.getElementById('addToPlaylistModal');
            if (event.target === createModal) {
                closeCreatePlaylistModal();
            }
            if (event.target === addModal) {
                closeAddToPlaylistModal();
            }
        }
        
        // Initialize the app
        init();

        // ==================== DOWNLOAD FUNCTIONALITY ====================
        
        let downloadJobs = new Map();
        let downloadJobsUpdateInterval = null;
        
        // Handle download URL input
        function handleDownloadInput(event) {
            if (event.key === 'Enter') {
                startDownload();
            }
        }
        
        // Start a new download
        async function startDownload() {
            const urlInput = document.getElementById('downloadUrl');
            const downloadBtn = document.querySelector('.btn-download');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a valid URL');
                return;
            }
            
            // Disable button and show loading
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Starting...';
            
            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Clear input and show success
                    urlInput.value = '';
                    showDownloadNotification('Download started successfully!', 'success');
                    
                    // Add job to local tracking
                    downloadJobs.set(result.job_id, {
                        id: result.job_id,
                        url: url,
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        title: 'Fetching metadata...'
                    });
                    
                    // Refresh jobs display
                    refreshDownloadJobs();
                    
                    // Start polling for updates if not already running
                    if (!downloadJobsUpdateInterval) {
                        startDownloadJobsPolling();
                    }
                } else {
                    showDownloadNotification(result.error || 'Failed to start download', 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showDownloadNotification('Network error occurred', 'error');
            } finally {
                // Re-enable button
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download';
            }
        }
        
        // Show download notification
        function showDownloadNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#1db954' : '#dc3545'};
                color: white;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }
        
        // Refresh download jobs from server
        async function refreshDownloadJobs() {
            try {
                const response = await fetch('/api/downloads');
                const jobs = await response.json();
                
                if (response.ok) {
                    // Update local jobs map
                    downloadJobs.clear();
                    jobs.forEach(job => {
                        downloadJobs.set(job.id, job);
                    });
                    
                    // Update UI
                    updateDownloadJobsDisplay();
                    updateDownloadStats();
                    
                    // Check if we need to continue polling
                    const hasActiveJobs = jobs.some(job => 
                        job.status === 'pending' || job.status === 'downloading'
                    );
                    
                    if (hasActiveJobs && !downloadJobsUpdateInterval) {
                        startDownloadJobsPolling();
                    } else if (!hasActiveJobs && downloadJobsUpdateInterval) {
                        stopDownloadJobsPolling();
                    }
                } else {
                    console.error('Failed to fetch download jobs');
                }
            } catch (error) {
                console.error('Error fetching download jobs:', error);
            }
        }
        
        // Start polling for download job updates
        function startDownloadJobsPolling() {
            if (downloadJobsUpdateInterval) return;
            
            downloadJobsUpdateInterval = setInterval(() => {
                refreshDownloadJobs();
            }, 2000); // Poll every 2 seconds
        }
        
        // Stop polling for download job updates
        function stopDownloadJobsPolling() {
            if (downloadJobsUpdateInterval) {
                clearInterval(downloadJobsUpdateInterval);
                downloadJobsUpdateInterval = null;
            }
        }
        
        // Update download jobs display
        function updateDownloadJobsDisplay() {
            const jobsContainer = document.getElementById('downloadJobs');
            const jobs = Array.from(downloadJobs.values()).sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            if (jobs.length === 0) {
                jobsContainer.innerHTML = `
                    <div class="no-downloads">
                        No downloads yet. Add a URL above to get started!
                    </div>
                `;
                return;
            }
            
            jobsContainer.innerHTML = jobs.map(job => `
                <div class="download-job">
                    <div class="job-header">
                        <div class="job-title">${escapeHtml(job.title || 'Processing...')}</div>
                        <div class="job-status status-${job.status}">${job.status}</div>
                    </div>
                    <div class="job-url">${escapeHtml(job.url)}</div>
                    ${job.status === 'downloading' ? `
                        <div class="job-progress-container" style="display: block;">
                            <div class="job-progress-bar">
                                <div class="job-progress-fill" style="width: ${job.progress || 0}%"></div>
                            </div>
                            <div class="job-progress-text">${job.progress || 0}% complete</div>
                        </div>
                    ` : ''}
                    ${job.error ? `
                        <div class="job-error">${escapeHtml(job.error)}</div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Update download statistics
        function updateDownloadStats() {
            const jobs = Array.from(downloadJobs.values());
            const total = jobs.length;
            const active = jobs.filter(job => 
                job.status === 'pending' || job.status === 'downloading'
            ).length;
            const completed = jobs.filter(job => job.status === 'completed').length;
            const failed = jobs.filter(job => job.status === 'failed').length;
            
            document.getElementById('totalDownloads').textContent = total;
            document.getElementById('activeDownloads').textContent = active;
            document.getElementById('completedDownloads').textContent = completed;
            document.getElementById('failedDownloads').textContent = failed;
        }
        
        // ==================== SEARCH FUNCTIONALITY ====================
        
        let performSearchTimeout;
        
        // Perform search in the music library
        function performSearch(event) {
            clearTimeout(performSearchTimeout);
            performSearchTimeout = setTimeout(() => {
                const query = event.target.value.toLowerCase().trim();
                const resultsContainer = document.getElementById('search-results');
                
                if (!query) {
                    resultsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">Enter a search term to find music</div>';
                    return;
                }
                
                // Filter tracks based on search query
                const filteredTracks = tracks.filter(track => 
                    track.title.toLowerCase().includes(query) ||
                    track.artist.toLowerCase().includes(query) ||
                    track.album.toLowerCase().includes(query)
                );
                
                if (filteredTracks.length === 0) {
                    resultsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">No results found</div>';
                    return;
                }
                
                // Display filtered tracks
                resultsContainer.innerHTML = filteredTracks.map(track => `
                    <div class="track-item" onclick="playTrack(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artist)}')">
                        <div class="track-info">
                            <div class="track-title">${escapeHtml(track.title)}</div>
                            <div class="track-artist">${escapeHtml(track.artist)}</div>
                            <div class="track-album">${escapeHtml(track.album)}</div>
                        </div>
                        <div class="track-actions">
                            <button class="play-btn" onclick="event.stopPropagation(); playTrack(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artist)}')">▶</button>
                            <button class="add-to-playlist-btn" onclick="event.stopPropagation(); openAddToPlaylistModal(${track.id})">+</button>
                        </div>
                    </div>
                `).join('');
            }, 150); // 150ms debounce
        }
        
        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', () => {
            stopDownloadJobsPolling();
        });
    </script>
</body>
</html>
